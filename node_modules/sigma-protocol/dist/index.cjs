var t=require("axios"),e=require("bsv-wasm"),r=require("buffer");function i(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=/*#__PURE__*/i(t);function n(){return n=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t},n.apply(this,arguments)}var o="5349474d41";exports.Algorithm=void 0,(exports.Algorithm||(exports.Algorithm={})).BSM="BSM",exports.Sigma=/*#__PURE__*/function(){function t(t,i,s,n){var a=this;void 0===i&&(i=0),void 0===s&&(s=0),void 0===n&&(n=0),this._inputHash=null,this._dataHash=null,this._transaction=void 0,this._sigmaInstance=void 0,this._refVin=void 0,this._targetVout=void 0,this._sig=void 0,this.setHashes=function(){a._inputHash=a.getInputHash(),a._dataHash=a.getDataHash()},this.setTargetVout=function(t){a._targetVout=t},this.setSigmaInstance=function(t){a._sigmaInstance=t},this.verify=function(){if(!a.sig)throw new Error("No signature data provided");if(!a.getMessageHash())throw new Error("No tx data provided");var t=e.P2PKHAddress.from_string(a.sig.address),i=e.Signature.from_compact_bytes(r.Buffer.from(a.sig.signature,"base64"));return t.verify_bitcoin_message(a.getMessageHash().to_bytes(),i)},this.getInputHash=function(){return a._getInputHashByVin(-1===a._refVin?a._targetVout:a._refVin)},this._getInputHashByVin=function(t){var r=a._transaction.get_input(t);return e.Hash.sha_256(r?r.get_outpoint_bytes():new Uint8Array(32))},this.getDataHash=function(){var t,r;if(!a._transaction)throw new Error("No transaction provided");for(var i=null==(t=a._transaction)||null==(r=t.get_output(a._targetVout))?void 0:r.get_script_pub_key(),s=(null==i?void 0:i.to_asm_string().split(" "))||[],n=0,u=0;u<s.length;u++)if(s[u].toUpperCase()===o.toUpperCase()){if(n===a._sigmaInstance){var g=s.slice(0,u-1),h=e.Script.from_asm_string(g.join(" "));return e.Hash.sha_256(h.to_bytes())}n++}var _=e.Script.from_asm_string(s.join(" "));return e.Hash.sha_256(_.to_bytes())},this._transaction=t,this._targetVout=i,this._refVin=n,this._sigmaInstance=s,this._sig=this.sig,this.setHashes()}var i,a,u=t.prototype;return u.getMessageHash=function(){if(!this._inputHash||!this._dataHash)throw new Error("Input hash and data hash must be set");var t=this._inputHash.to_bytes(),r=this._dataHash.to_bytes(),i=new Uint8Array(t.length+r.length);return i.set(t,0),i.set(r,t.length),e.Hash.sha_256(i)},u._sign=function(t,i){var s,a,u=-1===this._refVin?this._targetVout:this._refVin,g=o+" "+r.Buffer.from(exports.Algorithm.BSM,"utf-8").toString("hex")+" "+r.Buffer.from(i,"utf-8").toString("hex")+" "+t.to_compact_hex()+" "+r.Buffer.from(u.toString(),"utf-8").toString("hex"),h=e.Script.from_asm_string(g);this._sig={algorithm:exports.Algorithm.BSM,address:i,signature:r.Buffer.from(t.to_compact_bytes()).toString("base64"),vin:u,targetVout:this._targetVout};var _=null==(s=this.targetTxOut)?void 0:s.get_script_pub_key().to_asm_string(),f=(null==(a=_)?void 0:a.split(" ").includes("OP_RETURN"))?"7c":"OP_RETURN";if(this.sig&&this._sigmaInstance===this.getSigInstanceCount()){var p,c=(null==(p=_)?void 0:p.split(" "))||[],l=this.getSigInstancePosition(),v=g.split(" ");-1!==l&&(_=c.splice.apply(c,[l,5].concat(v)).join(""))}var d=e.Script.from_asm_string(_+" "+f+" "+g),m=e.Transaction.from_bytes(this._transaction.to_bytes()),y=new e.TxOut(this.targetTxOut.get_satoshis(),d);return m.set_output(this._targetVout,y),this._transaction=m,n({sigmaScript:h,signedTx:m},this._sig)},u.sign=function(t){var r=this.getMessageHash(),i=e.BSM.sign_message(t,r.to_bytes()),s=e.P2PKHAddress.from_pubkey(t.to_public_key()).to_string();return this._sign(i,s)},u.remoteSign=function(t,i){try{var o,a=this,u=i?((o={})[null==i?void 0:i.key]=null==i?void 0:i.value,o):{};return Promise.resolve(function(o,g){try{var h=Promise.resolve(s.default.post(t+"/sign"+("query"===(null==i?void 0:i.type)?"?"+(null==i?void 0:i.key)+"="+(null==i?void 0:i.value):""),{message:a.getMessageHash().to_hex(),encoding:"hex"},{headers:n({},u,{"Content-Type":"application/json",Accept:"application/json"})})).then(function(t){var i=t.data,s=i.address,n=e.Signature.from_compact_bytes(r.Buffer.from(i.sig,"base64"));return a._sign(n,s)})}catch(t){return g(t)}return h&&h.then?h.then(void 0,g):h}(0,function(t){throw console.log(t),new Error(t.response)}))}catch(t){return Promise.reject(t)}},u.getSigInstanceCount=function(){var t,e=null==(t=this.targetTxOut)?void 0:t.get_script_pub_key().to_asm_string();return((null==e?void 0:e.split(" "))||[]).filter(function(t){return t.toUpperCase()===o.toUpperCase()}).length},u.getSigInstancePosition=function(){var t,e=null==(t=this.targetTxOut)?void 0:t.get_script_pub_key().to_asm_string();return((null==e?void 0:e.split(" "))||[]).findIndex(function(t){return t.toUpperCase()===o.toUpperCase()})},i=t,(a=[{key:"transaction",get:function(){return this._transaction}},{key:"targetTxOut",get:function(){var t;return(null==(t=this._transaction)?void 0:t.get_output(this._targetVout))||null}},{key:"sig",get:function(){for(var t=this._transaction.get_output(this._targetVout),e=null==t?void 0:t.get_script_pub_key(),i=(null==e?void 0:e.to_asm_string().split(" "))||[],s=[],n=0;n<i.length;n++)if(i[n].toUpperCase()===o.toUpperCase()){var a={algorithm:r.Buffer.from(i[n+1],"hex").toString("utf-8"),address:r.Buffer.from(i[n+2],"hex").toString("utf-8"),signature:r.Buffer.from(i[n+3],"hex").toString("base64"),vin:parseInt(r.Buffer.from(i[n+4],"hex").toString("utf-8"))};s.push(a),n+=4}return 0===s.length?this._sig:s[this._sigmaInstance]}}])&&function(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,"symbol"==typeof(s=function(t,e){if("object"!=typeof t||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,"string");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(i.key))?s:String(s),i)}var s}(i.prototype,a),Object.defineProperty(i,"prototype",{writable:!1}),t}(),exports.sigmaHex=o;
//# sourceMappingURL=index.cjs.map
