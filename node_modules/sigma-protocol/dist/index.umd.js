!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("axios"),require("bsv-wasm"),require("buffer")):"function"==typeof define&&define.amd?define(["exports","axios","bsv-wasm","buffer"],e):e((t||self).sigmaProtocol={},t.axios,t.bsvWasm,t.buffer)}(this,function(t,e,i,r){function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=/*#__PURE__*/n(e);function o(){return o=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(t[r]=i[r])}return t},o.apply(this,arguments)}var a="5349474d41";t.Algorithm=void 0,(t.Algorithm||(t.Algorithm={})).BSM="BSM",t.Sigma=/*#__PURE__*/function(){function e(t,e,n,s){var o=this;void 0===e&&(e=0),void 0===n&&(n=0),void 0===s&&(s=0),this._inputHash=null,this._dataHash=null,this._transaction=void 0,this._sigmaInstance=void 0,this._refVin=void 0,this._targetVout=void 0,this._sig=void 0,this.setHashes=function(){o._inputHash=o.getInputHash(),o._dataHash=o.getDataHash()},this.setTargetVout=function(t){o._targetVout=t},this.setSigmaInstance=function(t){o._sigmaInstance=t},this.verify=function(){if(!o.sig)throw new Error("No signature data provided");if(!o.getMessageHash())throw new Error("No tx data provided");var t=i.P2PKHAddress.from_string(o.sig.address),e=i.Signature.from_compact_bytes(r.Buffer.from(o.sig.signature,"base64"));return t.verify_bitcoin_message(o.getMessageHash().to_bytes(),e)},this.getInputHash=function(){return o._getInputHashByVin(-1===o._refVin?o._targetVout:o._refVin)},this._getInputHashByVin=function(t){var e=o._transaction.get_input(t);return i.Hash.sha_256(e?e.get_outpoint_bytes():new Uint8Array(32))},this.getDataHash=function(){var t,e;if(!o._transaction)throw new Error("No transaction provided");for(var r=null==(t=o._transaction)||null==(e=t.get_output(o._targetVout))?void 0:e.get_script_pub_key(),n=(null==r?void 0:r.to_asm_string().split(" "))||[],s=0,u=0;u<n.length;u++)if(n[u].toUpperCase()===a.toUpperCase()){if(s===o._sigmaInstance){var g=n.slice(0,u-1),h=i.Script.from_asm_string(g.join(" "));return i.Hash.sha_256(h.to_bytes())}s++}var f=i.Script.from_asm_string(n.join(" "));return i.Hash.sha_256(f.to_bytes())},this._transaction=t,this._targetVout=e,this._refVin=s,this._sigmaInstance=n,this._sig=this.sig,this.setHashes()}var n,u,g=e.prototype;return g.getMessageHash=function(){if(!this._inputHash||!this._dataHash)throw new Error("Input hash and data hash must be set");var t=this._inputHash.to_bytes(),e=this._dataHash.to_bytes(),r=new Uint8Array(t.length+e.length);return r.set(t,0),r.set(e,t.length),i.Hash.sha_256(r)},g._sign=function(e,n){var s,u,g=-1===this._refVin?this._targetVout:this._refVin,h=a+" "+r.Buffer.from(t.Algorithm.BSM,"utf-8").toString("hex")+" "+r.Buffer.from(n,"utf-8").toString("hex")+" "+e.to_compact_hex()+" "+r.Buffer.from(g.toString(),"utf-8").toString("hex"),f=i.Script.from_asm_string(h);this._sig={algorithm:t.Algorithm.BSM,address:n,signature:r.Buffer.from(e.to_compact_bytes()).toString("base64"),vin:g,targetVout:this._targetVout};var _=null==(s=this.targetTxOut)?void 0:s.get_script_pub_key().to_asm_string(),c=(null==(u=_)?void 0:u.split(" ").includes("OP_RETURN"))?"7c":"OP_RETURN";if(this.sig&&this._sigmaInstance===this.getSigInstanceCount()){var l,p=(null==(l=_)?void 0:l.split(" "))||[],v=this.getSigInstancePosition(),d=h.split(" ");-1!==v&&(_=p.splice.apply(p,[v,5].concat(d)).join(""))}var m=i.Script.from_asm_string(_+" "+c+" "+h),y=i.Transaction.from_bytes(this._transaction.to_bytes()),b=new i.TxOut(this.targetTxOut.get_satoshis(),m);return y.set_output(this._targetVout,b),this._transaction=y,o({sigmaScript:f,signedTx:y},this._sig)},g.sign=function(t){var e=this.getMessageHash(),r=i.BSM.sign_message(t,e.to_bytes()),n=i.P2PKHAddress.from_pubkey(t.to_public_key()).to_string();return this._sign(r,n)},g.remoteSign=function(t,e){try{var n,a=this,u=e?((n={})[null==e?void 0:e.key]=null==e?void 0:e.value,n):{};return Promise.resolve(function(n,g){try{var h=Promise.resolve(s.default.post(t+"/sign"+("query"===(null==e?void 0:e.type)?"?"+(null==e?void 0:e.key)+"="+(null==e?void 0:e.value):""),{message:a.getMessageHash().to_hex(),encoding:"hex"},{headers:o({},u,{"Content-Type":"application/json",Accept:"application/json"})})).then(function(t){var e=t.data,n=e.address,s=i.Signature.from_compact_bytes(r.Buffer.from(e.sig,"base64"));return a._sign(s,n)})}catch(t){return g(t)}return h&&h.then?h.then(void 0,g):h}(0,function(t){throw console.log(t),new Error(t.response)}))}catch(t){return Promise.reject(t)}},g.getSigInstanceCount=function(){var t,e=null==(t=this.targetTxOut)?void 0:t.get_script_pub_key().to_asm_string();return((null==e?void 0:e.split(" "))||[]).filter(function(t){return t.toUpperCase()===a.toUpperCase()}).length},g.getSigInstancePosition=function(){var t,e=null==(t=this.targetTxOut)?void 0:t.get_script_pub_key().to_asm_string();return((null==e?void 0:e.split(" "))||[]).findIndex(function(t){return t.toUpperCase()===a.toUpperCase()})},n=e,(u=[{key:"transaction",get:function(){return this._transaction}},{key:"targetTxOut",get:function(){var t;return(null==(t=this._transaction)?void 0:t.get_output(this._targetVout))||null}},{key:"sig",get:function(){for(var t=this._transaction.get_output(this._targetVout),e=null==t?void 0:t.get_script_pub_key(),i=(null==e?void 0:e.to_asm_string().split(" "))||[],n=[],s=0;s<i.length;s++)if(i[s].toUpperCase()===a.toUpperCase()){var o={algorithm:r.Buffer.from(i[s+1],"hex").toString("utf-8"),address:r.Buffer.from(i[s+2],"hex").toString("utf-8"),signature:r.Buffer.from(i[s+3],"hex").toString("base64"),vin:parseInt(r.Buffer.from(i[s+4],"hex").toString("utf-8"))};n.push(o),s+=4}return 0===n.length?this._sig:n[this._sigmaInstance]}}])&&function(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,"symbol"==typeof(n=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var r=i.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(r.key))?n:String(n),r)}var n}(n.prototype,u),Object.defineProperty(n,"prototype",{writable:!1}),e}(),t.sigmaHex=a});
//# sourceMappingURL=index.umd.js.map
