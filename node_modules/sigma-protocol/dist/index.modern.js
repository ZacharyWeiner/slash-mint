import t from"axios";import{P2PKHAddress as s,Signature as i,Hash as e,Script as n,Transaction as r,TxOut as o,BSM as a}from"bsv-wasm";import{Buffer as h}from"buffer";function g(){return g=Object.assign?Object.assign.bind():function(t){for(var s=1;s<arguments.length;s++){var i=arguments[s];for(var e in i)Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e])}return t},g.apply(this,arguments)}const _="5349474d41";var u;!function(t){t.BSM="BSM"}(u||(u={}));class c{constructor(t,r=0,o=0,a=0){this._inputHash=null,this._dataHash=null,this._transaction=void 0,this._sigmaInstance=void 0,this._refVin=void 0,this._targetVout=void 0,this._sig=void 0,this.setHashes=()=>{this._inputHash=this.getInputHash(),this._dataHash=this.getDataHash()},this.setTargetVout=t=>{this._targetVout=t},this.setSigmaInstance=t=>{this._sigmaInstance=t},this.verify=()=>{if(!this.sig)throw new Error("No signature data provided");if(!this.getMessageHash())throw new Error("No tx data provided");const t=s.from_string(this.sig.address),e=i.from_compact_bytes(h.from(this.sig.signature,"base64"));return t.verify_bitcoin_message(this.getMessageHash().to_bytes(),e)},this.getInputHash=()=>this._getInputHashByVin(-1===this._refVin?this._targetVout:this._refVin),this._getInputHashByVin=t=>{const s=this._transaction.get_input(t);return e.sha_256(s?s.get_outpoint_bytes():new Uint8Array(32))},this.getDataHash=()=>{var t,s;if(!this._transaction)throw new Error("No transaction provided");const i=null==(t=this._transaction)||null==(s=t.get_output(this._targetVout))?void 0:s.get_script_pub_key(),r=(null==i?void 0:i.to_asm_string().split(" "))||[];let o=0;for(let t=0;t<r.length;t++)if(r[t].toUpperCase()===_.toUpperCase()){if(o===this._sigmaInstance){const s=r.slice(0,t-1),i=n.from_asm_string(s.join(" "));return e.sha_256(i.to_bytes())}o++}const a=n.from_asm_string(r.join(" "));return e.sha_256(a.to_bytes())},this._transaction=t,this._targetVout=r,this._refVin=a,this._sigmaInstance=o,this._sig=this.sig,this.setHashes()}getMessageHash(){if(!this._inputHash||!this._dataHash)throw new Error("Input hash and data hash must be set");const t=this._inputHash.to_bytes(),s=this._dataHash.to_bytes(),i=new Uint8Array(t.length+s.length);return i.set(t,0),i.set(s,t.length),e.sha_256(i)}get transaction(){return this._transaction}_sign(t,s){var i,e;const a=-1===this._refVin?this._targetVout:this._refVin,c=`${_} ${h.from(u.BSM,"utf-8").toString("hex")} ${h.from(s,"utf-8").toString("hex")} ${t.to_compact_hex()} ${h.from(a.toString(),"utf-8").toString("hex")}`,l=n.from_asm_string(c);this._sig={algorithm:u.BSM,address:s,signature:h.from(t.to_compact_bytes()).toString("base64"),vin:a,targetVout:this._targetVout};let p=null==(i=this.targetTxOut)?void 0:i.get_script_pub_key().to_asm_string();const f=(null==(e=p)?void 0:e.split(" ").includes("OP_RETURN"))?"7c":"OP_RETURN";let m="";if(this.sig&&this._sigmaInstance===this.getSigInstanceCount()){var d;const t=(null==(d=p)?void 0:d.split(" "))||[],s=this.getSigInstancePosition(),i=c.split(" ");-1!==s&&(p=t.splice(s,5,...i).join(""))}m=`${p} ${f} ${c}`;const v=n.from_asm_string(m),y=r.from_bytes(this._transaction.to_bytes()),b=new o(this.targetTxOut.get_satoshis(),v);return y.set_output(this._targetVout,b),this._transaction=y,g({sigmaScript:l,signedTx:y},this._sig)}sign(t){const i=this.getMessageHash();let e=a.sign_message(t,i.to_bytes());const n=s.from_pubkey(t.to_public_key()).to_string();return this._sign(e,n)}async remoteSign(s,e){const n=e?{[null==e?void 0:e.key]:null==e?void 0:e.value}:{};try{const r=await t.post(`${s}/sign${"query"===(null==e?void 0:e.type)?"?"+(null==e?void 0:e.key)+"="+(null==e?void 0:e.value):""}`,{message:this.getMessageHash().to_hex(),encoding:"hex"},{headers:g({},n,{"Content-Type":"application/json",Accept:"application/json"})}),{address:o,sig:a}=r.data,_=i.from_compact_bytes(h.from(a,"base64"));return this._sign(_,o)}catch(t){throw console.log(t),new Error(t.response)}}get targetTxOut(){var t;return(null==(t=this._transaction)?void 0:t.get_output(this._targetVout))||null}get sig(){const t=this._transaction.get_output(this._targetVout),s=null==t?void 0:t.get_script_pub_key(),i=(null==s?void 0:s.to_asm_string().split(" "))||[],e=[];for(let t=0;t<i.length;t++)if(i[t].toUpperCase()===_.toUpperCase()){const s={algorithm:h.from(i[t+1],"hex").toString("utf-8"),address:h.from(i[t+2],"hex").toString("utf-8"),signature:h.from(i[t+3],"hex").toString("base64"),vin:parseInt(h.from(i[t+4],"hex").toString("utf-8"))};e.push(s),t+=4}return 0===e.length?this._sig:e[this._sigmaInstance]}getSigInstanceCount(){var t;const s=null==(t=this.targetTxOut)?void 0:t.get_script_pub_key().to_asm_string();return((null==s?void 0:s.split(" "))||[]).filter(t=>t.toUpperCase()===_.toUpperCase()).length}getSigInstancePosition(){var t;const s=null==(t=this.targetTxOut)?void 0:t.get_script_pub_key().to_asm_string();return((null==s?void 0:s.split(" "))||[]).findIndex(t=>t.toUpperCase()===_.toUpperCase())}}export{u as Algorithm,c as Sigma,_ as sigmaHex};
//# sourceMappingURL=index.modern.js.map
