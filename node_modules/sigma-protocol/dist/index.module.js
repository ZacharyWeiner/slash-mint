import t from"axios";import{Hash as i,Script as e,Transaction as n,TxOut as r,BSM as s,P2PKHAddress as o,Signature as a}from"bsv-wasm";import{Buffer as u}from"buffer";function g(){return g=Object.assign?Object.assign.bind():function(t){for(var i=1;i<arguments.length;i++){var e=arguments[i];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t},g.apply(this,arguments)}var _,h="5349474d41";!function(t){t.BSM="BSM"}(_||(_={}));var c=/*#__PURE__*/function(){function c(t,n,r,s){var g=this;void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=0),this._inputHash=null,this._dataHash=null,this._transaction=void 0,this._sigmaInstance=void 0,this._refVin=void 0,this._targetVout=void 0,this._sig=void 0,this.setHashes=function(){g._inputHash=g.getInputHash(),g._dataHash=g.getDataHash()},this.setTargetVout=function(t){g._targetVout=t},this.setSigmaInstance=function(t){g._sigmaInstance=t},this.verify=function(){if(!g.sig)throw new Error("No signature data provided");if(!g.getMessageHash())throw new Error("No tx data provided");var t=o.from_string(g.sig.address),i=a.from_compact_bytes(u.from(g.sig.signature,"base64"));return t.verify_bitcoin_message(g.getMessageHash().to_bytes(),i)},this.getInputHash=function(){return g._getInputHashByVin(-1===g._refVin?g._targetVout:g._refVin)},this._getInputHashByVin=function(t){var e=g._transaction.get_input(t);return i.sha_256(e?e.get_outpoint_bytes():new Uint8Array(32))},this.getDataHash=function(){var t,n;if(!g._transaction)throw new Error("No transaction provided");for(var r=null==(t=g._transaction)||null==(n=t.get_output(g._targetVout))?void 0:n.get_script_pub_key(),s=(null==r?void 0:r.to_asm_string().split(" "))||[],o=0,a=0;a<s.length;a++)if(s[a].toUpperCase()===h.toUpperCase()){if(o===g._sigmaInstance){var u=s.slice(0,a-1),_=e.from_asm_string(u.join(" "));return i.sha_256(_.to_bytes())}o++}var c=e.from_asm_string(s.join(" "));return i.sha_256(c.to_bytes())},this._transaction=t,this._targetVout=n,this._refVin=s,this._sigmaInstance=r,this._sig=this.sig,this.setHashes()}var p,f,l=c.prototype;return l.getMessageHash=function(){if(!this._inputHash||!this._dataHash)throw new Error("Input hash and data hash must be set");var t=this._inputHash.to_bytes(),e=this._dataHash.to_bytes(),n=new Uint8Array(t.length+e.length);return n.set(t,0),n.set(e,t.length),i.sha_256(n)},l._sign=function(t,i){var s,o,a=-1===this._refVin?this._targetVout:this._refVin,c=h+" "+u.from(_.BSM,"utf-8").toString("hex")+" "+u.from(i,"utf-8").toString("hex")+" "+t.to_compact_hex()+" "+u.from(a.toString(),"utf-8").toString("hex"),p=e.from_asm_string(c);this._sig={algorithm:_.BSM,address:i,signature:u.from(t.to_compact_bytes()).toString("base64"),vin:a,targetVout:this._targetVout};var f=null==(s=this.targetTxOut)?void 0:s.get_script_pub_key().to_asm_string(),l=(null==(o=f)?void 0:o.split(" ").includes("OP_RETURN"))?"7c":"OP_RETURN";if(this.sig&&this._sigmaInstance===this.getSigInstanceCount()){var v,m=(null==(v=f)?void 0:v.split(" "))||[],d=this.getSigInstancePosition(),y=c.split(" ");-1!==d&&(f=m.splice.apply(m,[d,5].concat(y)).join(""))}var b=e.from_asm_string(f+" "+l+" "+c),S=n.from_bytes(this._transaction.to_bytes()),H=new r(this.targetTxOut.get_satoshis(),b);return S.set_output(this._targetVout,H),this._transaction=S,g({sigmaScript:p,signedTx:S},this._sig)},l.sign=function(t){var i=this.getMessageHash(),e=s.sign_message(t,i.to_bytes()),n=o.from_pubkey(t.to_public_key()).to_string();return this._sign(e,n)},l.remoteSign=function(i,e){try{var n,r=this,s=e?((n={})[null==e?void 0:e.key]=null==e?void 0:e.value,n):{};return Promise.resolve(function(n,o){try{var _=Promise.resolve(t.post(i+"/sign"+("query"===(null==e?void 0:e.type)?"?"+(null==e?void 0:e.key)+"="+(null==e?void 0:e.value):""),{message:r.getMessageHash().to_hex(),encoding:"hex"},{headers:g({},s,{"Content-Type":"application/json",Accept:"application/json"})})).then(function(t){var i=t.data,e=i.address,n=a.from_compact_bytes(u.from(i.sig,"base64"));return r._sign(n,e)})}catch(t){return o(t)}return _&&_.then?_.then(void 0,o):_}(0,function(t){throw console.log(t),new Error(t.response)}))}catch(t){return Promise.reject(t)}},l.getSigInstanceCount=function(){var t,i=null==(t=this.targetTxOut)?void 0:t.get_script_pub_key().to_asm_string();return((null==i?void 0:i.split(" "))||[]).filter(function(t){return t.toUpperCase()===h.toUpperCase()}).length},l.getSigInstancePosition=function(){var t,i=null==(t=this.targetTxOut)?void 0:t.get_script_pub_key().to_asm_string();return((null==i?void 0:i.split(" "))||[]).findIndex(function(t){return t.toUpperCase()===h.toUpperCase()})},p=c,(f=[{key:"transaction",get:function(){return this._transaction}},{key:"targetTxOut",get:function(){var t;return(null==(t=this._transaction)?void 0:t.get_output(this._targetVout))||null}},{key:"sig",get:function(){for(var t=this._transaction.get_output(this._targetVout),i=null==t?void 0:t.get_script_pub_key(),e=(null==i?void 0:i.to_asm_string().split(" "))||[],n=[],r=0;r<e.length;r++)if(e[r].toUpperCase()===h.toUpperCase()){var s={algorithm:u.from(e[r+1],"hex").toString("utf-8"),address:u.from(e[r+2],"hex").toString("utf-8"),signature:u.from(e[r+3],"hex").toString("base64"),vin:parseInt(u.from(e[r+4],"hex").toString("utf-8"))};n.push(s),r+=4}return 0===n.length?this._sig:n[this._sigmaInstance]}}])&&function(t,i){for(var e=0;e<i.length;e++){var n=i[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,"symbol"==typeof(r=function(t,i){if("object"!=typeof t||null===t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key))?r:String(r),n)}var r}(p.prototype,f),Object.defineProperty(p,"prototype",{writable:!1}),c}();export{_ as Algorithm,c as Sigma,h as sigmaHex};
//# sourceMappingURL=index.module.js.map
